GEOS-Chem TOMAS Installation
============================

The model GEOS-Chem model is disponible in multiples versions on Github repositories
whether the user want to execute simulations using the GCClassic, GCHP, or the WRF
version of the model for example. For the purpose of this guide, we will be looking
at the installation process of the Classic version of the model and configure the 
simulations with the intent of using the TOMAS module specifically. For more information 
and more general options related to the installation of the model, please see the 
`official GEOS-Chem documentation`_

1. Get source code
------------------

As mentionned before the GEOS-Chem Classic source code is available publicaly on 
Github and is bundled with some routines required to create run directories or test 
the model. As Stetson has an internet access, it is possible to directly download 
the source code on the cluster in the directory where you wish to run the model.

To download the latest stable verison of GCClassic from Github, simply type :

.. code-block:: console

    $ git clone --recurse-submodule https://github.com/geoschem/GCClassic.git

After the :command:`git clone` command has finished, you can verify that the download
succeded by naviguating to the :file:`GCClassic` folder and get a listing of the 
:file:`src` directory files.

.. code-block:: console

    $ cd GCClassic
    $ ls -CF src/*

Your command line output should look similar to this:

.. code-block:: text

    src/CMakeLists.txt

    src/GEOS-Chem:
    APM/          CMakeLists.txt  GeosRad/   Headers/     ISORROPIA/   NcdfUtil/  README.md
    AUTHORS.txt   CMakeScripts/   GeosUtil/  History/     KPP/         ObsPack/   run/
    CHANGELOG.md  GeosCore/       GTMM/      Interfaces/  LICENSE.txt  PKUCPL/    test/

    src/HEMCO:
    AUTHORS.txt   CMakeLists.txt  CONTRIBUTING.md  LICENSE.txt  run/  SUPPORT.md
    CHANGELOG.md  CMakeScripts/   docs/            README.md    src/

This will confirm that you have well fetched the source code for **GEOS-Chem** and 
**HEMCO**. The source code is respectively stored inside the :file:`GCClassic/src/GEOS-Chem`
and :file:`GCClassic/src/HEMCO` directories.

2. Creation of running directory
--------------------------------

The next step in preparing a GEOS-Chem TOMAS simulation is to create a run directory, 
where you will store simulations specific configuration files and were your outputs 
from the model will be saved. The source code of GEOS-Chem come with a shell script 
automating and greatly simplyfying the process of creating these directories.

The following steps are an example of the process necessary to create a full chemistry
simulation of GEOS-Chem classic with the TOMAS module enabled.

#. Navigate to your GCClassic source code folder. 

    .. code-block:: console

        $ cd /data12/pgbourdon/GCC_v14.1.1/GCClassic
        $ ls 

    You should see the following output:

    .. code-block:: text

        AUTHORS.txt   CMakeLists.txt  CONTRIBUTING.md  LICENSE.txt  run  SUPPORT.md
        CHANGELOG.md  CMakeScripts    docs             README.md    src  test

#. Navigate to the :file:`run` folder and make sure that the :file:`createRunDir.sh` script is present.

    .. code-block:: console

        $ cd run
        $ ls

#. Run the :file:`createRunDir.sh` script.

    .. code-block:: console

        $ ./createRunDir.sh

#. This will launch the creation process of your new run directory. The first time 
   you do this operation you will be asked to fill out a `first time user registration`_.
   Just follow the prompt and the run directory creation process will automatically follow.
   First you will be asked to supply which type of chemical species are to be considered in 
   the simulation you are creating: 

    .. code-block:: text

        ===========================================================
        GEOS-CHEM RUN DIRECTORY CREATION
        ===========================================================

        -----------------------------------------------------------
        Choose simulation type:
        -----------------------------------------------------------
        1. Full chemistry
        2. Aerosols only
        3. CH4
        4. CO2
        5. Hg
        6. POPs
        7. Tagged CH4
        8. Tagged CO
        9. Tagged O3
        10. TransportTracers
        11. Trace metals
        12. Carbon

    To create a simulation that consider all the chemical species available in GEOS-Chem,
    press :command:`1`, then press :command:`ENTER`.

#. You will then be asked to specify which options of the GEOS-Chem model you want
   to use. 

    .. code-block:: text

        -----------------------------------------------------------
        Choose additional simulation option:
        -----------------------------------------------------------
        1. Standard
        2. Benchmark
        3. Complex SOA
        4. Marine POA
        5. Acid uptake on dust
        6. TOMAS
        7. APM
        8. RRTMG

    To setup a simulation with the use of TOMAS microphysics, type :command:`6`, 
    followed by :command:`ENTER`. 

#. You will then be asked to provide the number of bins you want TOMAS to use to 
   represent the particle size distribution of each aerosols species it consider.

    .. code-block:: text

        -----------------------------------------------------------
        Choose TOMAS option:
        -----------------------------------------------------------
        1. TOMAS with 15 bins
        2. TOMAS with 40 bins

    You can start by using 15 bins (press :command:`1`) to get an idea of what information the model will 
    provide and to limit the computation time of the simulations while setting up 
    the model. Use 40 bins for more precission (press :command:`2`).

#. You will then be asked which meteorology type of data will be supplied to GEOS-Chem.

    .. code-block:: text

        -----------------------------------------------------------
        Choose meteorology source:
        -----------------------------------------------------------
        1. MERRA-2 (Recommended)
        2. GEOS-FP
        3. GISS ModelE2.1 (GCAP 2.0)

    The input data files preloaded on the Stetson cluster are mainly coming from **MERRA-2**.
    It is then recommended to use option :command:`1` when starting to use GEOS-Chem.

#. Next, you will have to provide the horizontal resolution of the grid to be used in 
   GEOS-Chem.

    .. code-block:: text

        -----------------------------------------------------------
        Choose horizontal resolution:
        -----------------------------------------------------------
        1. 4.0  x 5.0
        2. 2.0  x 2.5
        3. 0.5  x 0.625

    The fastest and easiest resolution to work with when starting to use GEOS-Chem 
    is the **4.0° x 5.0°** resolution (press :command:`1`). You can choose higher 
    resolution for more precission in your simulations, but the computation time will 
    increase.

#. After giving an appropriate grid resolution to be used by the model, you will 
   have to provide a vertical resolution for the simulation.

    .. code-block:: text

        -----------------------------------------------------------
        Choose number of levels:
        -----------------------------------------------------------
        1. 72 (native)
        2. 47 (reduced)

    For most use, the **72** pressure levels option (press :command:`1`) is recommended, 
    but you can easily use the reduced **47** pressure levels (press :command:`2`) 
    to start without loosing to much precission.

#. Next, you will be asked to provide a path where your run directory will be saved.
   
    .. code-block:: text

        -----------------------------------------------------------
        Enter path where the run directory will be created:
        -----------------------------------------------------------
        >>>

    The path you provide here can be either absolute, or relative. 

#. You will then be asked to provide a name for the run directory to be newly created.

    .. code-block:: text

        -----------------------------------------------------------
        Enter run directory name, or press return to use default:

        NOTE: This will be a subfolder of the path you entered above.
        -----------------------------------------------------------
        >>>

    If you don't enter any name and simply press :command:`ENTER`, the procedure 
    will use a default name for the directory that have the following structure:
    :file:`gc_4x5_47L_merra2_fullchem_TOMAS15`.

#. Finally, you will be asked if you want to track the changes made to that new 
   run directory by adding it to a git repository. 

    .. code-block:: text

        -----------------------------------------------------------
        Do you want to track run directory changes with git? (y/n)
        -----------------------------------------------------------
        >>>
    

3. Compilation of the code
--------------------------

4. Considerations specific to TOMAS
-----------------------------------

.. _official GEOS-Chem documentation: https://geos-chem.readthedocs.io/en/stable/index.html
.. _first time user registration: https://geos-chem.readthedocs.io/en/stable/gcc-guide/02-build/rundir-registration.html
